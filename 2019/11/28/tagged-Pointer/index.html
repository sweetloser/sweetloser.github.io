<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/avatar.gif?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/avatar.gif?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/avatar.gif?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="iOSå¼€å‘," />










<meta name="description" content="é—®é¢˜æ¥æºåœ¨æœ€è¿‘çš„ä¸€æ¬¡é¢è¯•è¿‡ç¨‹ä¸­ï¼Œè¢«é—®åˆ°Appleå¯¹tagged pointerçš„ä¼˜åŒ–çš„é—®é¢˜ï¼Œå½“æ—¶ä¸€è„¸æ‡µé€¼ï¼Œé™¤äº†è¯´ä¸Šä¸€å¥â€œæé«˜è®¿é—®æ•ˆç‡å’ŒèŠ‚çº¦å†…å­˜æˆæœ¬â€ï¼Œå°±æ²¡æœ‰ç„¶åäº†ï¼Œè¢«é—®åŠå…¶å®ç°åŸç†ä¸€æ¦‚ä¸çŸ¥ã€‚ä¸€æ—¶é™·å…¥å°´å°¬ï¼Œä¸çŸ¥é“å¯¹è¯è¯¥æ€ä¹ˆç»§ç»­ã€‚è¯ç©·çš„åŸå› ï¼Œå¤§æ¦‚æ˜¯å› ä¸ºæˆ‘çš„æ— çŸ¥å§ï¼æ‰€ä»¥è¿‡åï¼Œèµ¶ç´§è¡¥ä¸Šè¿™æ–¹é¢çš„çŸ¥è¯†ï¼ æ¢ç´¢å†ç¨‹1ã€ç™¾åº¦æ—¢ç„¶æ‰“ç®—æŒæ¡tagged pointerçš„ç›¸å…³çŸ¥è¯†ï¼Œè‚¯å®šè¦çŸ¥é“å®ƒæ˜¯ä»€ä¹ˆï¼Œå¹²ä»€ä¹ˆç”¨çš„ï¼Œæ€ä¹ˆå®">
<meta property="og:type" content="article">
<meta property="og:title" content="tagged Pointer">
<meta property="og:url" content="https://www.sweetloser.com/2019/11/28/tagged-Pointer/index.html">
<meta property="og:site_name" content="SweetLoser Blog">
<meta property="og:description" content="é—®é¢˜æ¥æºåœ¨æœ€è¿‘çš„ä¸€æ¬¡é¢è¯•è¿‡ç¨‹ä¸­ï¼Œè¢«é—®åˆ°Appleå¯¹tagged pointerçš„ä¼˜åŒ–çš„é—®é¢˜ï¼Œå½“æ—¶ä¸€è„¸æ‡µé€¼ï¼Œé™¤äº†è¯´ä¸Šä¸€å¥â€œæé«˜è®¿é—®æ•ˆç‡å’ŒèŠ‚çº¦å†…å­˜æˆæœ¬â€ï¼Œå°±æ²¡æœ‰ç„¶åäº†ï¼Œè¢«é—®åŠå…¶å®ç°åŸç†ä¸€æ¦‚ä¸çŸ¥ã€‚ä¸€æ—¶é™·å…¥å°´å°¬ï¼Œä¸çŸ¥é“å¯¹è¯è¯¥æ€ä¹ˆç»§ç»­ã€‚è¯ç©·çš„åŸå› ï¼Œå¤§æ¦‚æ˜¯å› ä¸ºæˆ‘çš„æ— çŸ¥å§ï¼æ‰€ä»¥è¿‡åï¼Œèµ¶ç´§è¡¥ä¸Šè¿™æ–¹é¢çš„çŸ¥è¯†ï¼ æ¢ç´¢å†ç¨‹1ã€ç™¾åº¦æ—¢ç„¶æ‰“ç®—æŒæ¡tagged pointerçš„ç›¸å…³çŸ¥è¯†ï¼Œè‚¯å®šè¦çŸ¥é“å®ƒæ˜¯ä»€ä¹ˆï¼Œå¹²ä»€ä¹ˆç”¨çš„ï¼Œæ€ä¹ˆå®">
<meta property="og:locale">
<meta property="og:image" content="https://www.sweetloser.com/2019/11/28/tagged-Pointer/1.png">
<meta property="og:image" content="https://www.sweetloser.com/2019/11/28/tagged-Pointer/2.png">
<meta property="og:image" content="https://www.sweetloser.com/2019/11/28/tagged-Pointer/3.png">
<meta property="og:image" content="https://www.sweetloser.com/2019/11/28/tagged-Pointer/4.png">
<meta property="og:image" content="https://www.sweetloser.com/2019/11/28/tagged-Pointer/5.png">
<meta property="og:image" content="https://www.sweetloser.com/2019/11/28/tagged-Pointer/6.png">
<meta property="og:image" content="https://www.sweetloser.com/2019/11/28/tagged-Pointer/7.png">
<meta property="article:published_time" content="2019-11-28T07:51:58.000Z">
<meta property="article:modified_time" content="2024-02-27T07:16:53.619Z">
<meta property="article:author" content="SweetLoser">
<meta property="article:tag" content="iOSå¼€å‘">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.sweetloser.com/2019/11/28/tagged-Pointer/1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'åšä¸»'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://www.sweetloser.com/2019/11/28/tagged-Pointer/"/>





  <title>tagged Pointer | SweetLoser Blog</title>
  








<meta name="generator" content="Hexo 6.3.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">SweetLoser Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">æ ‘å¶çš„ä¸€ç”Ÿï¼Œéš¾é“åªæ˜¯ä¸ºäº†å½’æ ¹å—</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            æ ‡ç­¾
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            åˆ†ç±»
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            å½’æ¡£
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.sweetloser.com/2019/11/28/tagged-Pointer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SweetLoser Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">tagged Pointer</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2019-11-28T15:51:58+08:00">
                2019-11-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/11/28/tagged-Pointer/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/11/28/tagged-Pointer/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">å­—æ•°ç»Ÿè®¡&#58;</span>
                
                <span title="å­—æ•°ç»Ÿè®¡">
                  5.9k å­—
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
                
                <span title="é˜…è¯»æ—¶é•¿">
                  29 åˆ†é’Ÿ
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="é—®é¢˜æ¥æº"><a href="#é—®é¢˜æ¥æº" class="headerlink" title="é—®é¢˜æ¥æº"></a>é—®é¢˜æ¥æº</h1><p>åœ¨æœ€è¿‘çš„ä¸€æ¬¡é¢è¯•è¿‡ç¨‹ä¸­ï¼Œè¢«é—®åˆ°Appleå¯¹<code>tagged pointer</code>çš„ä¼˜åŒ–çš„é—®é¢˜ï¼Œå½“æ—¶ä¸€è„¸æ‡µé€¼ï¼Œé™¤äº†è¯´ä¸Šä¸€å¥â€œæé«˜è®¿é—®æ•ˆç‡å’ŒèŠ‚çº¦å†…å­˜æˆæœ¬â€ï¼Œå°±æ²¡æœ‰ç„¶åäº†ï¼Œè¢«é—®åŠå…¶å®ç°åŸç†ä¸€æ¦‚ä¸çŸ¥ã€‚ä¸€æ—¶é™·å…¥å°´å°¬ï¼Œä¸çŸ¥é“å¯¹è¯è¯¥æ€ä¹ˆç»§ç»­ã€‚è¯ç©·çš„åŸå› ï¼Œå¤§æ¦‚æ˜¯å› ä¸ºæˆ‘çš„æ— çŸ¥å§ï¼æ‰€ä»¥è¿‡åï¼Œèµ¶ç´§è¡¥ä¸Šè¿™æ–¹é¢çš„çŸ¥è¯†ï¼</p>
<h1 id="æ¢ç´¢å†ç¨‹"><a href="#æ¢ç´¢å†ç¨‹" class="headerlink" title="æ¢ç´¢å†ç¨‹"></a>æ¢ç´¢å†ç¨‹</h1><h2 id="1ã€ç™¾åº¦"><a href="#1ã€ç™¾åº¦" class="headerlink" title="1ã€ç™¾åº¦"></a>1ã€ç™¾åº¦</h2><p>æ—¢ç„¶æ‰“ç®—æŒæ¡<code>tagged pointer</code>çš„ç›¸å…³çŸ¥è¯†ï¼Œè‚¯å®šè¦çŸ¥é“å®ƒæ˜¯ä»€ä¹ˆï¼Œå¹²ä»€ä¹ˆç”¨çš„ï¼Œæ€ä¹ˆå®ç°çš„ï¼Œä¼˜åŠ¿&amp;åŠ£åŠ¿ç­‰ç­‰ã€‚ä¸€å¤§å †çš„é—®é¢˜ï¼Œå°†æˆ‘æ¹®ç­ï¼Œè¿˜å¥½ï¼Œæˆ‘æœ‰<a target="_blank" rel="noopener" href="http://www.baidu.com/s?wd=taggedpointer">åº¦å¨˜</a>ã€‚<br>soâ€¦<br><img src="/2019/11/28/tagged-Pointer/1.png" alt="ç™¾åº¦.png"><br>ä¸€çœ‹è¿™ä¹ˆå¤šï¼Œæ±‚çŸ¥æ¬²çˆ†æ£šçš„æˆ‘ç¬é—´é«˜æ½®äº†ï¼Œå†…å¿ƒç®€ç›´ã€‚ã€‚ã€‚ã€‚ã€‚æ— æ³•ç”¨è¨€è¯­å½¢å®¹ã€‚å°è¯•ç€é˜…è¯»äº†å‡ ç¯‡ï¼Œå‘ç°è§£é‡Šçš„éƒ½å¾ˆç‰‡é¢å’Œè‚¤æµ…ï¼Œå’Œæˆ‘æƒ³è¦çš„ç›¸å·®ç”šè¿œã€‚æœ‰ç‚¹å°å¤±è½ã€‚ä½†æ˜¯ï¼Œæˆ‘å¯æ˜¯â€œå¥½å¥½å­¦ä¹ å¤©å¤©å‘ä¸Šâ€çš„å¥½å­¦ç”Ÿï¼Œç¥–å›½çš„èŠ±æœµï¼Œå…±äº§ä¸»ä¹‰çš„æ¥ç­äººå•Šï¼Œæ€èƒ½è½»è¨€æ”¾å¼ƒå‘¢ã€‚äºæ˜¯ç»§ç»­åœ¨ä¸€å †ä¼˜ï¼ˆåƒï¼‰ç§€ï¼ˆåœ¾ï¼‰ä¸­è¿½æ±‚çœŸç†ã€‚ã€‚ã€‚</p>
<p>çš‡å¤©ä¸è´Ÿæœ‰å¿ƒäººã€‚<br><img src="/2019/11/28/tagged-Pointer/2.png" alt="image.png"><br>çœ‹åˆ°å”å·§å¤§ä½¬ä¹Ÿæœ‰è¿‡è¿™æ–¹é¢çš„ç ”ç©¶ã€‚å—¯å—¯ï¼Œçœ‹æ¥æˆ‘å’Œå¤§ä½¬ä¹‹é—´ï¼Œå°±å·®ä¸€ä¸ª<code>tagged pointer</code>çš„æŒæ¡ï¼ï¼ï¼ï¼ˆçªƒå–œ&amp;YYè‡ªå·±æ­£èµ°åœ¨æˆä¸ºå¤§ä½¬çš„è·¯ä¸Š.pngï¼‰<br>ç‚¹å¼€<a target="_blank" rel="noopener" href="http://blog.devtang.com/2014/05/30/understand-tagged-pointer">å¤§ä½¬åšå®¢</a>ï¼Œä¼¼ä¹å¥½åƒï¼Œå¤§ä½¬å¯¹<code>tagged pointer</code>ä¹Ÿæ²¡æœ‰å¤ªå¤šçš„è§£æï¼Œè®©è¯»è€…çŸ¥å…¶å¤§æ¦‚ã€‚é¡¿æ—¶é™·å…¥äº†è¿·èŒ«å’Œæ€è€ƒï¼šæˆ‘æƒ³è¦çš„ä»…ä»…æ˜¯è¿™äº›è¡¨é¢çš„çŸ¥å…¶ç„¶è€Œä¸çŸ¥å…¶æ‰€ä»¥ç„¶çš„æ‰€è°“çš„çŸ¥è¯†å—ï¼Ÿè„‘æµ·ä¸­é—ªè¿‡æ— æ•°é¸¡æ±¤ï¼Œç¬é—´é¡¿æ‚Ÿï¼šå»å§çš®å¡ä¸˜ï¼Œè¿½å¯»ä½ æƒ³è¦çš„å§ï¼</p>
<hr>
<h2 id="2ã€Developer-Documention"><a href="#2ã€Developer-Documention" class="headerlink" title="2ã€Developer Documention"></a>2ã€Developer Documention</h2><p>å¹²åŠ²æ˜¯æœ‰äº†ï¼Œé‚£ä»å“ªé‡Œå…¥æ‰‹å‘¢ï¼Œæ€ä¹ˆå»å­¦ä¹ <code>tagged pointer</code>å‘¢ã€‚è¿™æ—¶ï¼Œæˆ‘æƒ³åˆ°äº†å®˜æ–¹æ–‡æ¡£ï¼Œäºæ˜¯æ‰“å¼€xcodeï¼Œ<code>Help</code>â€“&gt;<code>Developer Documention</code>ï¼Œæœç´¢<code>Tagged Pointer</code>:<br><img src="/2019/11/28/tagged-Pointer/3.png" alt="image.png"><br>WTFâ€¦.<br>å†…å¿ƒä¸€ä¸‡å¤´è‰æ³¥é©¬å¥”è…¾è€Œè¿‡~~~<br>åæ¥æƒ³æƒ³ï¼Œæ„Ÿè§‰è‡ªå·±å¥½å‚»é€¼ï¼Œ<code>Developer Documention</code>æ˜¯å¼€å‘è€…æ¥å£æ–‡æ¡£ï¼Œtagged pointeråˆä¸æ˜¯æ¥å£ï¼Œæ˜¯Appleå¯¹NSStringã€NSNumberã€NSDateç­‰ç±»çš„ä¼˜åŒ–ã€‚ä¼˜åŒ–ã€‚ä¼˜åŒ–ã€‚é¢ï¼Œï¼Œå¥½åƒå“ªé‡Œä¸å¯¹ï¼Œä¼˜åŒ–ä¸æ˜¯åº•å±‚å®ç°çš„å—ï¼Œæ¢ç´¢åº•å±‚ï¼Œä¸åº”è¯¥å»çœ‹<code>runtime</code>å—ã€‚è¯¶ï¼Œç»ˆç©¶è¿˜æ˜¯å¤ªå¹´è½»ï¼Œä¸ºä»€ä¹ˆç°åœ¨æ‰æƒ³èµ·æ¥è¦çœ‹runtimeï¼Œçœ‹æ¥å…±äº§ä¸»ä¹‰è¿Ÿè¿Ÿä¸è®©ä½ æ¥ç­ï¼Œè¿˜æ˜¯æœ‰åŸå› çš„ï¼ï¼ï¼</p>
<h2 id="runtimeæºç "><a href="#runtimeæºç " class="headerlink" title="runtimeæºç "></a>runtimeæºç </h2><p>æ—¢ç„¶çŸ¥é“äº†è·¯åœ¨ä½•æ–¹ï¼Œå°±ä¸åœ¨è¿·èŒ«~<br>åºŸè¯ä¸å¤šè¯´ï¼Œå…ˆå»<a target="_blank" rel="noopener" href="https://opensource.apple.com/tarballs/objc4">OpenSource</a>ä¸‹è½½ä¸€ä»½<code>runtime</code>æºç ã€‚<br>è¿™é‡Œä¸‹è½½ä¸€ä»½æœ€æ–°çš„<code>objc-750</code>ã€‚<br>ä¸‹è½½å®Œåï¼Œæˆ‘éšéšæ„Ÿè§‰åˆ°ï¼Œæˆ‘ç¦»æŒæ¡<code>Tagged Pointer</code>å·²ç»ä¸è¿œäº†ã€‚<br>äºæ˜¯ï¼ŒæŠ‘åˆ¶ä½æ¿€åŠ¨çš„å¿ƒï¼Œæ§åˆ¶ä½é¢¤æŠ–çš„æ‰‹ï¼Œç‚¹å¼€<code>objc-750</code>æºç ï¼Œå¥½å§ï¼Œæˆ‘åˆè¿·å¤±åœ¨äº†æ— å°½çš„å¤´æ–‡ä»¶ä¸­ã€‚<br><img src="/2019/11/28/tagged-Pointer/4.png" alt="image.png"><br>è¿™å°¼ç›ï¼ŒTagged Pointerç›¸å…³çš„çŸ¥è¯†ï¼Œåœ¨å“ªä¸ªå¤´æ–‡ä»¶ï¼Ÿæ€»ä¸èƒ½ä¸€ä¸ªä¸ªå»æ‰¾å§ï¼Ÿä½ å¯èƒ½è§‰å¾—æˆ‘å·²ç»åœ¨å¤´æ–‡ä»¶ä¸­è¿·å¤±è‡ªæˆ‘äº†ï¼Œæˆ‘åªèƒ½è¯´ï¼šå‘µï¼Œå¤©çœŸï¼Œæˆ‘å¯æ˜¯å…±äº§ä¸»ä¹‰çš„æ¥ç­äººï¼Œè¿™å°±æƒ³éš¾é“æˆ‘ï¼Ÿ<br>äºæ˜¯æˆ‘ç‚¹å¼€äº†æ–‡ä»¶æœç´¢ğŸ˜~<br><img src="/2019/11/28/tagged-Pointer/5.png" alt="image.png"><br>è¿™TMä¹Ÿæœ‰å¥½å‡ ä¸ªå•Šå•Šå•Šå•Šå•Šå•Šã€‚æ²¡åŠæ³•ï¼Œåªèƒ½å†æ¬¡æ±‚åŠ©<a target="_blank" rel="noopener" href="https://www.baidu.com/s?wd=runtime%20taggedpointer">åº¦å¨˜</a>ã€‚<br>ä¸€ç•ªæŸ¥æ‰¾ï¼Œç»ˆäºæ‰¾åˆ°äº†<code>objc-internal.h</code>ã€‚(çªƒå–œ.jpg)<br>æ€»ç®—è¿›å…¥æ­£é¢˜äº†ï¼ˆè¿›å…¥å…¨ç¥è´¯æ³¨æ¨¡å¼.jpgï¼‰ã€‚<br>å¼€å§‹é˜…è¯»æºç ï¼š<br><img src="/2019/11/28/tagged-Pointer/6.png" alt="image.png"><br>è¿™é‡Œå¯ä»¥çœ‹æ³¨é‡Šï¼Œæ–‡ä»¶ä¸­å…³äº<code>Tagged Pointer</code>çš„ï¼Œå¤§æ¦‚åœ¨209è¡Œçš„ä½ç½®ï¼š<br><img src="/2019/11/28/tagged-Pointer/7.png" alt="image.png"><br>æ‰€ä»¥ç›´æ¥çœ‹è¿™é‡Œã€‚<br>å¼€å§‹çš„ä½ç½®ï¼Œæ˜¯å¯¹64ä½ç³»ç»Ÿçš„åˆ¤å®šï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#if __LP64__</span><br><span class="line">#define OBJC_HAVE_TAGGED_POINTERS 1  //å¦‚æœæ˜¯64ä½ç³»ç»Ÿï¼Œåˆ™å®šä¹‰å®OBJC_HAVE_TAGGED_POINTERS</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>
<p>ç„¶åä¸‹é¢å°±å¯¹<code>OBJC_HAVE_TAGGED_POINTERS</code>å®è¿›è¡Œåˆ¤å®šï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#if OBJC_HAVE_TAGGED_POINTERS    //è¯´æ˜tagged pointeråªå­˜åœ¨äº64ä½ç³»ç»Ÿä¸­ï¼Œå³Appleæ˜¯åœ¨64ä½ç³»ç»Ÿä¸Šç”¨tagged pointerä¼˜åŒ–NSStringç­‰ç±»çš„ã€‚</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>ç»§ç»­å¾€ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">#if __has_feature(objc_fixed_enum)  ||  __cplusplus &gt;= 201103L</span><br><span class="line">enum objc_tag_index_t : uint16_t</span><br><span class="line">#else</span><br><span class="line">typedef uint16_t objc_tag_index_t;</span><br><span class="line">enum</span><br><span class="line">#endif</span><br><span class="line">&#123;</span><br><span class="line">    // 60-bit payloads</span><br><span class="line">    OBJC_TAG_NSAtom            = 0, </span><br><span class="line">    OBJC_TAG_1                 = 1, </span><br><span class="line">    OBJC_TAG_NSString          = 2, </span><br><span class="line">    OBJC_TAG_NSNumber          = 3, </span><br><span class="line">    OBJC_TAG_NSIndexPath       = 4, </span><br><span class="line">    OBJC_TAG_NSManagedObjectID = 5, </span><br><span class="line">    OBJC_TAG_NSDate            = 6,</span><br><span class="line"></span><br><span class="line">    // 60-bit reserved</span><br><span class="line">    OBJC_TAG_RESERVED_7        = 7, </span><br><span class="line"></span><br><span class="line">    // 52-bit payloads</span><br><span class="line">    OBJC_TAG_Photos_1          = 8,</span><br><span class="line">    OBJC_TAG_Photos_2          = 9,</span><br><span class="line">    OBJC_TAG_Photos_3          = 10,</span><br><span class="line">    OBJC_TAG_Photos_4          = 11,</span><br><span class="line">    OBJC_TAG_XPC_1             = 12,</span><br><span class="line">    OBJC_TAG_XPC_2             = 13,</span><br><span class="line">    OBJC_TAG_XPC_3             = 14,</span><br><span class="line">    OBJC_TAG_XPC_4             = 15,</span><br><span class="line"></span><br><span class="line">    OBJC_TAG_First60BitPayload = 0, </span><br><span class="line">    OBJC_TAG_Last60BitPayload  = 6, </span><br><span class="line">    OBJC_TAG_First52BitPayload = 8, </span><br><span class="line">    OBJC_TAG_Last52BitPayload  = 263, </span><br><span class="line"></span><br><span class="line">    OBJC_TAG_RESERVED_264      = 264</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ä¸€çœ‹åˆ°<code>#if</code> ã€<code>#else</code>ã€<code>#endif</code>ï¼Œå°±çŸ¥é“åœ¨åšåˆ¤æ–­ã€‚<br>çœ‹ä¸€ä¸‹å…·ä½“åœ¨åˆ¤æ–­ä»€ä¹ˆï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#if __has_feature(objc_fixed_enum)  ||  __cplusplus &gt;= 201103L</span><br><span class="line">/*</span><br><span class="line">  __has_feature(objc_fixed_enum):</span><br><span class="line">__has_feature evaluates to 1 if the feature is both supported by Clang and standardized in the current language standard or 0 if not.</span><br><span class="line">ç¿»è¯‘ä¸€ä¸‹å°±æ˜¯ï¼š__has_featureå–å€¼ä¸º1å¦‚æœç‰¹æ€§è¢«Clangæ”¯æŒå¹¶ä¸”è¢«æ ‡å‡†åŒ–åœ¨å½“å‰çš„è¯­è¨€æ ‡å‡†ä¸­ï¼Œå–å€¼ä¸º0å¦‚æœä¸æ˜¯çš„è¯ã€‚ï¼ˆåŸè°…æˆ‘è€¿ï¼ˆåƒï¼‰ç›´ï¼ˆåœ¾ï¼‰çš„ç¿»è¯‘ï¼ï¼ï¼ï¼‰</span><br><span class="line">Use __has_feature(objc_fixed_enum) to determine whether support for fixed underlying types is available in Objective-C.</span><br><span class="line">ç¿»è¯‘ï¼šç”¨__has_feature(objc_fixed_enum)æ¥å†³å®šæ˜¯å¦æ”¯æŒå›ºå®šçš„åŸºç¡€ç±»å‹åœ¨Objective-Cä¸­ã€‚ï¼ˆæˆ‘ä¹Ÿä¸çŸ¥é“åœ¨è¯´å•¥~ï¼‰</span><br><span class="line">__cplusplus &gt;= 201103Lï¼š</span><br><span class="line">C++11æˆ–è€…æ›´æ–°çš„æ ‡å‡†ã€‚</span><br><span class="line">*/</span><br><span class="line">enum objc_tag_index_t : uint16_t</span><br><span class="line">/*</span><br><span class="line">å®šä¹‰æšä¸¾objc_tag_index_tï¼Œæšä¸¾ç±»å‹ä¸ºï¼šuint16_t</span><br><span class="line">è¿™æ˜¯c++11ä¹‹åçš„ç‰¹æ€§</span><br><span class="line">*/</span><br><span class="line">#else</span><br><span class="line">typedef uint16_t objc_tag_index_t;</span><br><span class="line">enum</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢æ˜¯ä¸€äº›æšä¸¾å€¼ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    // 60-bit payloads</span><br><span class="line">    OBJC_TAG_NSAtom            = 0, </span><br><span class="line">    OBJC_TAG_1                 = 1, </span><br><span class="line">    OBJC_TAG_NSString          = 2,   //NSString</span><br><span class="line">    OBJC_TAG_NSNumber          = 3,  //NSNumber</span><br><span class="line">    OBJC_TAG_NSIndexPath       = 4, //NSIndexPath</span><br><span class="line">    OBJC_TAG_NSManagedObjectID = 5, </span><br><span class="line">    OBJC_TAG_NSDate            = 6,//NSDate  </span><br><span class="line"></span><br><span class="line">    // 60-bit reserved</span><br><span class="line">    OBJC_TAG_RESERVED_7        = 7, </span><br><span class="line"></span><br><span class="line">    // 52-bit payloads</span><br><span class="line">    OBJC_TAG_Photos_1          = 8,</span><br><span class="line">    OBJC_TAG_Photos_2          = 9,</span><br><span class="line">    OBJC_TAG_Photos_3          = 10,</span><br><span class="line">    OBJC_TAG_Photos_4          = 11,</span><br><span class="line">    OBJC_TAG_XPC_1             = 12,</span><br><span class="line">    OBJC_TAG_XPC_2             = 13,</span><br><span class="line">    OBJC_TAG_XPC_3             = 14,</span><br><span class="line">    OBJC_TAG_XPC_4             = 15,</span><br><span class="line"></span><br><span class="line">    OBJC_TAG_First60BitPayload = 0, </span><br><span class="line">    OBJC_TAG_Last60BitPayload  = 6, </span><br><span class="line">    OBJC_TAG_First52BitPayload = 8, </span><br><span class="line">    OBJC_TAG_Last52BitPayload  = 263, </span><br><span class="line"></span><br><span class="line">    OBJC_TAG_RESERVED_264      = 264</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥ï¼Œå°±æ˜¯ä¸€äº›å…³äº<code>tagged pointer</code>çš„å‡½æ•°äº†ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">// Returns true if tagged pointers are enabled.</span><br><span class="line">// The other functions below must not be called if tagged pointers are disabled.</span><br><span class="line">static inline bool </span><br><span class="line">_objc_taggedPointersEnabled(void);</span><br><span class="line"></span><br><span class="line">// Register a class for a tagged pointer tag.</span><br><span class="line">// Aborts if the tag is invalid or already in use.</span><br><span class="line">OBJC_EXPORT void</span><br><span class="line">_objc_registerTaggedPointerClass(objc_tag_index_t tag, Class _Nonnull cls)</span><br><span class="line">    OBJC_AVAILABLE(10.9, 7.0, 9.0, 1.0, 2.0);</span><br><span class="line"></span><br><span class="line">// Returns the registered class for the given tag.</span><br><span class="line">// Returns nil if the tag is valid but has no registered class.</span><br><span class="line">// Aborts if the tag is invalid.</span><br><span class="line">OBJC_EXPORT Class _Nullable</span><br><span class="line">_objc_getClassForTag(objc_tag_index_t tag)</span><br><span class="line">    OBJC_AVAILABLE(10.9, 7.0, 9.0, 1.0, 2.0);</span><br><span class="line"></span><br><span class="line">// Create a tagged pointer object with the given tag and payload.</span><br><span class="line">// Assumes the tag is valid.</span><br><span class="line">// Assumes tagged pointers are enabled.</span><br><span class="line">// The payload will be silently truncated to fit.</span><br><span class="line">static inline void * _Nonnull</span><br><span class="line">_objc_makeTaggedPointer(objc_tag_index_t tag, uintptr_t payload);</span><br><span class="line"></span><br><span class="line">// Return true if ptr is a tagged pointer object.</span><br><span class="line">// Does not check the validity of ptr&#x27;s class.</span><br><span class="line">static inline bool </span><br><span class="line">_objc_isTaggedPointer(const void * _Nullable ptr);</span><br><span class="line"></span><br><span class="line">// Extract the tag value from the given tagged pointer object.</span><br><span class="line">// Assumes ptr is a valid tagged pointer object.</span><br><span class="line">// Does not check the validity of ptr&#x27;s tag.</span><br><span class="line">static inline objc_tag_index_t </span><br><span class="line">_objc_getTaggedPointerTag(const void * _Nullable ptr);</span><br><span class="line"></span><br><span class="line">// Extract the payload from the given tagged pointer object.</span><br><span class="line">// Assumes ptr is a valid tagged pointer object.</span><br><span class="line">// The payload value is zero-extended.</span><br><span class="line">static inline uintptr_t</span><br><span class="line">_objc_getTaggedPointerValue(const void * _Nullable ptr);</span><br><span class="line"></span><br><span class="line">// Extract the payload from the given tagged pointer object.</span><br><span class="line">// Assumes ptr is a valid tagged pointer object.</span><br><span class="line">// The payload value is sign-extended.</span><br><span class="line">static inline intptr_t</span><br><span class="line">_objc_getTaggedPointerSignedValue(const void * _Nullable ptr);</span><br></pre></td></tr></table></figure>
<p>ä¸­é—´ä¹Ÿæœ‰å„ä¸ªå‡½æ•°çš„æ³¨é‡Šï¼Œè¿˜ç®—æ³¨é‡Šçš„æ¯”è¾ƒæ¸…æ¥šã€‚é‚£æˆ‘ä»¬å°±æ ¹æ®æ³¨é‡Šå’Œæºç ï¼Œä¸€ä¸ªä¸ªçœ‹å…¶å®ç°å§ï¼ˆä¸‹é¢å°†å£°æ˜å’Œå®ç°çš„ä»£ç ç²˜è´´åˆ°ä¸€èµ·ï¼‰ï¼š<br><code>_objc_taggedPointersEnabled </code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// Returns true if tagged pointers are enabled.</span><br><span class="line">// The other functions below must not be called if tagged pointers are disabled.</span><br><span class="line">/*</span><br><span class="line">ç¿»è¯‘ï¼šè¿”å›trueå¦‚æœtagged pointers æ˜¯è¢«å…è®¸çš„ã€‚</span><br><span class="line">     ä¸‹é¢çš„å…¶å®ƒå‡½æ•°ä¸èƒ½è¢«è°ƒç”¨å¦‚æœtagged pointersè¢«ç¦ç”¨ã€‚</span><br><span class="line">*/</span><br><span class="line">static inline bool </span><br><span class="line">_objc_taggedPointersEnabled(void);</span><br><span class="line"></span><br><span class="line">static inline bool </span><br><span class="line">_objc_taggedPointersEnabled(void)</span><br><span class="line">&#123;</span><br><span class="line">    extern uintptr_t objc_debug_taggedpointer_mask;</span><br><span class="line">    //å¼•å…¥ä¸€ä¸ªå¤–éƒ¨å˜é‡ objc_debug_taggedpointer_mask</span><br><span class="line">    return (objc_debug_taggedpointer_mask != 0);</span><br><span class="line">  //å¦‚æœobjc_debug_taggedpointer_maskä¸ºä¸º0ï¼Œåˆ™è¿”å›flase,å¦åˆ™è¿”å›true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªå‡½æ•°çš„å®ç°å…¶å®å¾ˆç®€å•ï¼Œå…³é”®æ˜¯<code>objc_debug_taggedpointer_mask</code>ï¼Œè¿™æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ï¼Ÿ<br>å®ƒæ—¢ç„¶è¢«<code>extern</code>å¼•å…¥ï¼Œè¯´æ˜ä»–åœ¨å…¶ä»–æ–‡ä»¶ä¸­è‚¯å®šè¢«å®šä¹‰å¹¶åˆå§‹åŒ–è¿‡ã€‚soï¼Œæ‰¾åˆ°å®ƒã€‚<br>åœ¨<code>objc-gdb.h</code>ä¸­æ‰¾åˆ°äº†ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">OBJC_EXPORT uintptr_t objc_debug_taggedpointer_mask</span><br><span class="line">    OBJC_AVAILABLE(10.9, 7.0, 9.0, 1.0, 2.0);</span><br><span class="line"></span><br><span class="line">//è¿™é‡Œç”¨OBJC_EXPORTå¯¼å‡ºobjc_debug_taggedpointer_maskã€‚</span><br><span class="line">//OBJC_EXPORTçš„å®šä¹‰ä¸ºï¼š</span><br><span class="line"></span><br><span class="line">#if !defined(OBJC_EXPORT)</span><br><span class="line">#   define OBJC_EXPORT  OBJC_EXTERN OBJC_VISIBLE</span><br><span class="line"></span><br><span class="line">//è€ŒOBJC_EXTERNçš„å®šä¹‰ä¸ºï¼š</span><br><span class="line"></span><br><span class="line">#if !defined(OBJC_EXTERN)</span><br><span class="line">#   if defined(__cplusplus)</span><br><span class="line">#       define OBJC_EXTERN extern &quot;C&quot; </span><br><span class="line">#   else</span><br><span class="line">#       define OBJC_EXTERN extern</span><br><span class="line">#   endif</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">//OBJC_VISIBLEçš„å®šä¹‰ä¸ºï¼š</span><br><span class="line">#if !defined(OBJC_VISIBLE)</span><br><span class="line"></span><br><span class="line">#       define OBJC_VISIBLE  __attribute__((visibility(&quot;default&quot;)))</span><br><span class="line"></span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">//æ‰€ä»¥è¿™å¥ç›¸å½“äºï¼š</span><br><span class="line">extern &quot;C&quot; __attribute__((visibility(&quot;default&quot;))) uintptr_t objc_debug_taggedpointer_mask</span><br><span class="line">    OBJC_AVAILABLE(10.9, 7.0, 9.0, 1.0, 2.0);</span><br><span class="line"></span><br><span class="line">//åŒæ ·çš„ï¼ŒOBJC_AVAILABLEä¹Ÿå¯ä»¥æ‰¾åˆ°å…¶å®šä¹‰ï¼š</span><br><span class="line">/* OBJC_AVAILABLE: shorthand for all-OS availability */</span><br><span class="line"></span><br><span class="line">#if !defined(OBJC_AVAILABLE)</span><br><span class="line">#   define OBJC_AVAILABLE(x, i, t, w, b)                            \</span><br><span class="line">        __OSX_AVAILABLE(x)  __IOS_AVAILABLE(i)  __TVOS_AVAILABLE(t) \</span><br><span class="line">        __WATCHOS_AVAILABLE(w)  __BRIDGEOS_AVAILABLE(b)</span><br><span class="line">#endif</span><br><span class="line">/*å¯è§ï¼ŒOBJC_AVAILABLEå°†æ‰©å±•ä¸º4ä¸ªå®ï¼Œæ‹¿__OSX_AVAILABLEæ¥çœ‹çœ‹å§ï¼š*/</span><br><span class="line"></span><br><span class="line">/* for use marking APIs available info for Mac OSX */</span><br><span class="line"></span><br><span class="line">#if defined(__has_attribute)</span><br><span class="line">  #if __has_attribute(availability)</span><br><span class="line">    #define __OSX_UNAVAILABLE                    __OS_AVAILABILITY(macosx,unavailable)</span><br><span class="line">    #define __OSX_AVAILABLE(_vers)               __OS_AVAILABILITY(macosx,introduced=_vers)</span><br><span class="line">    #define __OSX_DEPRECATED(_start, _dep, _msg) __OSX_AVAILABLE(_start) __OS_AVAILABILITY_MSG(macosx,deprecated=_dep,_msg)</span><br><span class="line">  #endif</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#define __OS_AVAILABILITY(_target, _availability)            __attribute__((availability(_target,_availability)))</span><br><span class="line"></span><br><span class="line">//æ‰€ä»¥ï¼š</span><br><span class="line">#define __OSX_AVAILABLE(x)  __attribute__((availability(macosx,x)))</span><br><span class="line">//å…¶ä»–çš„ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œè¿™é‡Œå°±ä¸å±•å¼€å¤šè¯´äº†ã€‚å…¶å®ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†é™åˆ¶ç‰ˆæœ¬çš„ã€‚</span><br><span class="line">//å…³äº__attribute__((availability(macosx,x))) ï¼š</span><br><span class="line">/*</span><br><span class="line"></span><br><span class="line">å¹³å°ï¼Œå¯ä¸ºmacosx, ios, tvos, watchosï¼›</span><br><span class="line">ä½•æ—¶å¼•å…¥ï¼Œintroduced=ç‰ˆæœ¬ï¼›</span><br><span class="line">ä½•æ—¶å¼ƒç”¨ï¼Œdeprecated=ç‰ˆæœ¬ï¼›</span><br><span class="line">ä½•æ—¶åºŸå¼ƒï¼Œobsoleted=ç‰ˆæœ¬ï¼›</span><br><span class="line">ä¸å¯ç”¨ï¼Œunavailableï¼Œæ ‡è¯†æ­¤å¹³å°ä¸å¯ç”¨ï¼›</span><br><span class="line">é¢å¤–ä¿¡æ¯ï¼Œmessage=å­—ç¬¦ä¸²ï¼Œå¯ç”¨æ¥é¢å¤–è¯´æ˜ï¼Œå¦‚æç¤ºæ–°çš„å¯ç”¨çš„æ›¿ä»£æ–¹æ³•ã€‚</span><br><span class="line">*/</span><br><span class="line">/*æ‰€ä»¥ï¼ŒOBJC_EXPORT uintptr_t objc_debug_taggedpointer_mask</span><br><span class="line">    OBJC_AVAILABLE(10.9, 7.0, 9.0, 1.0, 2.0);</span><br><span class="line">æ‰©å±•å¼€æ¥å…¶å®æ˜¯è¿™æ ·çš„ï¼š</span><br><span class="line">*/</span><br><span class="line">extern &quot;C&quot; __attribute__((visibility(&quot;default&quot;))) uintptr_t objc_debug_taggedpointer_mask __attribute__((availability(macosx,introduced=10.9))) __attribute__((availability(ios, introduced=7.0,))) __attribute__((availability(tvos,introduced=9.0))) __attribute__((availability(watchos,introduced=1.0,))) __attribute__((availability(bridgeos,introduced=2.0,))) </span><br><span class="line">    </span><br><span class="line">/*</span><br><span class="line">æäº†è¿™ä¹ˆå¤šï¼Œå„ç§defineå¥—defineï¼Œæçš„èŠ±é‡Œèƒ¡å“¨çš„ï¼Œå…¶å®å¥è¯ä¸»è¦å°±æ˜¯è¯´ï¼š</span><br><span class="line">objc_debug_taggedpointer_maskè¿™ä¸ªç¬¦å·è¢«å¯¼å…¥ï¼Œå¯è§ç±»å‹ä¸º`default `ï¼Œä¸”è¿™ä¸ªç¬¦å·ï¼Œåˆ†åˆ«åœ¨macosx10.9ã€ios7.0ã€tvos9.0ã€watchos1.0ã€bridgeos2.0æ—¶è¢«å¼•å…¥çš„ã€‚</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>
<p>ç„¶è€Œï¼Œæäº†åŠå¤©ï¼Œè¿˜æ˜¯ä¸çŸ¥é“<code>objc_debug_taggedpointer_mask</code>çš„å€¼å•Šã€‚<br>æ‰€ä»¥ç»§ç»­æ¢ç´¢ã€‚<br>ä¸€ç•ªå¯»æ‰¾ä¹‹åï¼Œç»ˆäºæ‰¾åˆ°äº†å…¶èµ‹å€¼çš„ä½ç½®ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">uintptr_t objc_debug_taggedpointer_mask = _OBJC_TAG_MASK;</span><br><span class="line"></span><br><span class="line">#if OBJC_MSB_TAGGED_POINTERS</span><br><span class="line">#   define _OBJC_TAG_MASK (1UL&lt;&lt;63)</span><br><span class="line">#else</span><br><span class="line">#   define _OBJC_TAG_MASK 1UL</span><br><span class="line"></span><br><span class="line">#if (TARGET_OS_OSX || TARGET_OS_IOSMAC) &amp;&amp; __x86_64__</span><br><span class="line">    // 64-bit Mac - tag bit is LSB    </span><br><span class="line">//è¿™é‡Œæ³¨é‡Šçš„å¾ˆæ¸…æ¥šäº†ï¼Œ64ä½çš„macï¼Œtaggedæ ‡è¯†ä½ä½LSBï¼ˆæœ€ä½æœ‰æ•ˆä½ï¼‰</span><br><span class="line">#   define OBJC_MSB_TAGGED_POINTERS 0</span><br><span class="line">#else</span><br><span class="line">    // Everything else - tag bit is MSB</span><br><span class="line">//å…¶ä»–çš„taggedæ ‡è¯†ä½éƒ½ä¸ºMSBï¼ˆæœ€é«˜æœ‰æ•ˆä½ï¼‰</span><br><span class="line">#   define OBJC_MSB_TAGGED_POINTERS 1</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>
<p>ç»•è¿™ä¹ˆä¸€å¤§åœˆï¼Œå±…ç„¶ç»™æˆ‘è¯´æ˜¯è¿™ä¸ªï¼Ÿso interestingï¼ï¼ï¼<br>å›åˆ°æœ€æœ€åˆçš„é‚£ä¸ª<code>_objc_taggedPointersEnabled</code>å‡½æ•°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">static inline bool </span><br><span class="line">_objc_taggedPointersEnabled(void);</span><br><span class="line"></span><br><span class="line">static inline bool </span><br><span class="line">_objc_taggedPointersEnabled(void)</span><br><span class="line">&#123;</span><br><span class="line">    extern uintptr_t objc_debug_taggedpointer_mask;</span><br><span class="line">    return (objc_debug_taggedpointer_mask != 0);</span><br><span class="line">/*</span><br><span class="line">è¿™é‡Œç­‰ä»·äºï¼š</span><br><span class="line">if(64bit system)</span><br><span class="line">&#123;</span><br><span class="line">  return true;</span><br><span class="line">&#125;</span><br><span class="line">return flase;</span><br><span class="line">*/</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªå‡½æ•°ç®—æ˜¯å¼„æ¸…æ¥šäº†ï¼Œæ¥ä¸‹æ¥çœ‹å¦ä¸€ä¸ªå‡½æ•°ã€‚<br><code>_objc_registerTaggedPointerClass</code>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">OBJC_EXPORT void</span><br><span class="line">_objc_registerTaggedPointerClass(objc_tag_index_t tag, Class _Nonnull cls)</span><br><span class="line">    OBJC_AVAILABLE(10.9, 7.0, 9.0, 1.0, 2.0);</span><br><span class="line">/***********************************************************************</span><br><span class="line">* _objc_registerTaggedPointerClass</span><br><span class="line">* Set the class to use for the given tagged pointer index.</span><br><span class="line">* Aborts if the tag is out of range, or if the tag is already </span><br><span class="line">* used by some other class.</span><br><span class="line">**********************************************************************/</span><br><span class="line">void</span><br><span class="line">_objc_registerTaggedPointerClass(objc_tag_index_t tag, Class cls)</span><br><span class="line">&#123;</span><br><span class="line">    if (objc_debug_taggedpointer_mask == 0) &#123;//é¦–å…ˆåˆ¤æ–­ç³»ç»Ÿæ˜¯å¦æ”¯æŒtagged pointer ã€‚objc_debug_taggedpointer_mask=0ä¸ºtagged pointer disabledï¼›</span><br><span class="line">        _objc_fatal(&quot;tagged pointers are disabled&quot;);</span><br><span class="line">/*</span><br><span class="line">è°ƒç”¨_objc_fatalå‡½æ•°ã€‚</span><br><span class="line">è¿™æ˜¯_objc_fatalçš„å®ç°ï¼š</span><br><span class="line">void _objc_fatal(const char *fmt, ...)</span><br><span class="line">&#123;</span><br><span class="line">    va_list args;</span><br><span class="line">    va_start(args, fmt);</span><br><span class="line">    _vcprintf(fmt, args);</span><br><span class="line">    va_end(args);</span><br><span class="line">//é€šè¿‡va_listè·å–æ ¼å¼åŒ–å‚æ•°ï¼Œå¹¶è¾“å‡ºã€‚</span><br><span class="line">    _cprintf(&quot;\n&quot;);</span><br><span class="line"></span><br><span class="line">    abort();</span><br><span class="line">//é€€å‡º</span><br><span class="line">&#125;</span><br><span class="line">*/</span><br><span class="line">//æ‰€ä»¥è¿™é‡Œçš„æ„æ€å°±æ˜¯è¾“å‡º&quot;tagged pointers are disabled&quot;å¹¶é€€å‡ºã€‚</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Class *slot = classSlotForTagIndex(tag);</span><br><span class="line">    if (!slot) &#123;</span><br><span class="line">        _objc_fatal(&quot;tag index %u is invalid&quot;, (unsigned int)tag);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Class oldCls = *slot;</span><br><span class="line">    </span><br><span class="line">    if (cls  &amp;&amp;  oldCls  &amp;&amp;  cls != oldCls) &#123;</span><br><span class="line">        _objc_fatal(&quot;tag index %u used for two different classes &quot;</span><br><span class="line">                    &quot;(was %p %s, now %p %s)&quot;, tag, </span><br><span class="line">                    oldCls, oldCls-&gt;nameForLogging(), </span><br><span class="line">                    cls, cls-&gt;nameForLogging());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *slot = cls;</span><br><span class="line"></span><br><span class="line">    // Store a placeholder class in the basic tag slot that is </span><br><span class="line">    // reserved for the extended tag space, if it isn&#x27;t set already.</span><br><span class="line">    // Do this lazily when the first extended tag is registered so </span><br><span class="line">    // that old debuggers characterize bogus pointers correctly more often.</span><br><span class="line">    if (tag &lt; OBJC_TAG_First60BitPayload || tag &gt; OBJC_TAG_Last60BitPayload) &#123;</span><br><span class="line">        Class *extSlot = classSlotForBasicTagIndex(OBJC_TAG_RESERVED_7);</span><br><span class="line">        if (*extSlot == nil) &#123;</span><br><span class="line">            extern objc_class OBJC_CLASS_$___NSUnrecognizedTaggedPointer;</span><br><span class="line">            *extSlot = (Class)&amp;OBJC_CLASS_$___NSUnrecognizedTaggedPointer;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>ç»§ç»­å¾€ä¸‹çœ‹çš„è¯ï¼Œåˆé‡åˆ°ä¸€ä¸ªä¹‹å‰æ²¡æœ‰çœ‹è¿‡çš„å‡½æ•°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Class * classSlotForTagIndex(tag);</span><br></pre></td></tr></table></figure>
<p>åœ¨runtimeä¸­æ‰¾åˆ°å®ƒçš„å®ç°éƒ¨åˆ†ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">// Returns a pointer to the class&#x27;s storage in the tagged class arrays, </span><br><span class="line">// or nil if the tag is out of range.</span><br><span class="line">/*</span><br><span class="line">æ³¨é‡Šï¼šè¿”å›ä¸€ä¸ªæŒ‡é’ˆç»™ç±»çš„å­˜å‚¨åœ¨tagged class æ•°ç»„ä¸­ã€‚</span><br><span class="line">*/</span><br><span class="line">static Class *  </span><br><span class="line">classSlotForTagIndex(objc_tag_index_t tag)</span><br><span class="line">&#123;</span><br><span class="line">    if (tag &gt;= OBJC_TAG_First60BitPayload &amp;&amp; tag &lt;= OBJC_TAG_Last60BitPayload) &#123;</span><br><span class="line">//è¿™é‡Œåˆ¤æ–­tagged pointerçš„payloadsä½ï¼Œæ˜¯å¦ä¸º60ä½payloadsã€‚</span><br><span class="line">/*</span><br><span class="line">// 60-bit payloads</span><br><span class="line">    OBJC_TAG_NSAtom            = 0, </span><br><span class="line">    OBJC_TAG_1                 = 1, </span><br><span class="line">    OBJC_TAG_NSString          = 2, </span><br><span class="line">    OBJC_TAG_NSNumber          = 3, </span><br><span class="line">    OBJC_TAG_NSIndexPath       = 4, </span><br><span class="line">    OBJC_TAG_NSManagedObjectID = 5, </span><br><span class="line">    OBJC_TAG_NSDate            = 6,</span><br><span class="line">*/</span><br><span class="line">//ä»¥ä¸Š7ç§ç±»å‹éƒ½ä¸º60bit payloadsï¼ˆç”¨60bitæ¥å­˜å‚¨æ•°æ®ï¼‰</span><br><span class="line">        return classSlotForBasicTagIndex(tag);//è°ƒç”¨å¦ä¸€ä¸ªå‡½æ•°ï¼Œè¿™é‡Œæ‰¾åˆ°å®ƒçš„å®ç°ï¼ˆåœ¨ä¸‹é¢å¯¹å…¶åˆ†æï¼‰</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (tag &gt;= OBJC_TAG_First52BitPayload &amp;&amp; tag &lt;= OBJC_TAG_Last52BitPayload) &#123;</span><br><span class="line">        int index = tag - OBJC_TAG_First52BitPayload;</span><br><span class="line">        uintptr_t tagObfuscator = ((objc_debug_taggedpointer_obfuscator</span><br><span class="line">                                    &gt;&gt; _OBJC_TAG_EXT_INDEX_SHIFT)</span><br><span class="line">                                   &amp; _OBJC_TAG_EXT_INDEX_MASK);</span><br><span class="line">        return &amp;objc_tag_ext_classes[index ^ tagObfuscator];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return nil;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ†æ<code>classSlotForBasicTagIndex</code>å‡½æ•°ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// Returns a pointer to the class&#x27;s storage in the tagged class arrays.</span><br><span class="line">// Assumes the tag is a valid basic tag.å‡è®¾æ ‡å¿—æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„æ ‡å¿—ï¼ˆåœ¨ä¸Šå±‚è°ƒç”¨ä¸­å·²ç»åˆ¤æ–­äº†tagï¼‰</span><br><span class="line">static Class *</span><br><span class="line">classSlotForBasicTagIndex(objc_tag_index_t tag)</span><br><span class="line">&#123;</span><br><span class="line">//è¿™é‡Œåˆå‡ºç°ä¸€ä¸ªå¥‡æ€ªçš„å˜é‡objc_debug_taggedpointer_obfuscatorğŸ˜ã€‚ã€‚ã€‚çœ‹çœ‹ä»–åˆ°åº•æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Ÿ</span><br><span class="line">    uintptr_t tagObfuscator = ((objc_debug_taggedpointer_obfuscator</span><br><span class="line">                                &gt;&gt; _OBJC_TAG_INDEX_SHIFT)</span><br><span class="line">                               &amp; _OBJC_TAG_INDEX_MASK);</span><br><span class="line">    uintptr_t obfuscatedTag = tag ^ tagObfuscator;</span><br><span class="line">    // Array index in objc_tag_classes includes the tagged bit itself</span><br><span class="line">#if SUPPORT_MSB_TAGGED_POINTERS</span><br><span class="line">    return &amp;objc_tag_classes[0x8 | obfuscatedTag];</span><br><span class="line">#else</span><br><span class="line">    return &amp;objc_tag_classes[(obfuscatedTag &lt;&lt; 1) | 1];</span><br><span class="line">#endif</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ†æ<code>objc_debug_taggedpointer_obfuscator</code>ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">/***********************************************************************</span><br><span class="line">* initializeTaggedPointerObfuscatorï¼ˆåˆå§‹åŒ–initializeTaggedPointerObfuscatorï¼‰</span><br><span class="line">* Initialize objc_debug_taggedpointer_obfuscator with randomness.ï¼ˆåˆå§‹åŒ–objc_debug_taggedpointer_obfuscatorç”¨éšæœºæ•°æ®ï¼‰</span><br><span class="line">*</span><br><span class="line">* The tagged pointer obfuscator is intended to make it more difficult</span><br><span class="line">* for an attacker to construct a particular object as a tagged pointer,</span><br><span class="line">* in the presence of a buffer overflow or other write control over some</span><br><span class="line">* memory. The obfuscator is XORed with the tagged pointers when setting</span><br><span class="line">* or retrieving payload values. They are filled with randomness on first</span><br><span class="line">* use.</span><br><span class="line">**********************************************************************/</span><br><span class="line">static void</span><br><span class="line">initializeTaggedPointerObfuscator(void)</span><br><span class="line">&#123;</span><br><span class="line">    if (sdkIsOlderThan(10_14, 12_0, 12_0, 5_0, 3_0) ||</span><br><span class="line">        // Set the obfuscator to zero for apps linked against older SDKs,</span><br><span class="line">        // in case they&#x27;re relying on the tagged pointer representation.</span><br><span class="line">        DisableTaggedPointerObfuscation) &#123;</span><br><span class="line">/*</span><br><span class="line">// OPTION(var, env, help)</span><br><span class="line">OPTION( DisableTaggedPointerObfuscation, OBJC_DISABLE_TAG_OBFUSCATION,    &quot;disable obfuscation of tagged pointers&quot;)</span><br><span class="line">*/</span><br><span class="line">/*</span><br><span class="line">#define sdkIsOlderThan(x, i, t, w) (sdkVersion() &lt; DYLD_OS_VERSION(x, i, t, w))</span><br><span class="line">#if TARGET_OS_OSX</span><br><span class="line">#   define DYLD_OS_VERSION(x, i, t, w) DYLD_MACOSX_VERSION_##x</span><br><span class="line">#   define sdkVersion() dyld_get_program_sdk_version()</span><br><span class="line"></span><br><span class="line">#elif TARGET_OS_IOS</span><br><span class="line">#   define DYLD_OS_VERSION(x, i, t, w) DYLD_IOS_VERSION_##i</span><br><span class="line">#   define sdkVersion() dyld_get_program_sdk_version()</span><br><span class="line"></span><br><span class="line">#elif TARGET_OS_TV</span><br><span class="line">    // dyld does not currently have distinct constants for tvOS</span><br><span class="line">#   define DYLD_OS_VERSION(x, i, t, w) DYLD_IOS_VERSION_##t</span><br><span class="line">#   define sdkVersion() dyld_get_program_sdk_version()</span><br><span class="line"></span><br><span class="line">#elif TARGET_OS_WATCH</span><br><span class="line">#   define DYLD_OS_VERSION(x, i, t, w) DYLD_WATCHOS_VERSION_##w</span><br><span class="line">    // watchOS has its own API for compatibility reasons</span><br><span class="line">#   define sdkVersion() dyld_get_program_sdk_watch_os_version()</span><br><span class="line"></span><br><span class="line">#else</span><br><span class="line">#   error unknown OS</span><br><span class="line">#endif</span><br><span class="line">*/</span><br><span class="line">        objc_debug_taggedpointer_obfuscator = 0;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line"></span><br><span class="line">        // Pull random data into the variable, then shift away all non-payload bits.ï¼ˆå°†éšæœºæ•°æ®æ”¾å…¥å˜é‡ä¸­ï¼Œç„¶åç§»èµ°æ‰€æœ‰éæœ‰æ•ˆè´Ÿè½½ä½ã€‚ï¼‰</span><br><span class="line">        arc4random_buf(&amp;objc_debug_taggedpointer_obfuscator,</span><br><span class="line">                       sizeof(objc_debug_taggedpointer_obfuscator));</span><br><span class="line">    //arc4random_buf() fills the region buf of length nbytes with random data.</span><br><span class="line"></span><br><span class="line">        objc_debug_taggedpointer_obfuscator &amp;= ~_OBJC_TAG_MASK;</span><br><span class="line">//è·å–ä¸€ä¸ªéšæœºæ•°ï¼Œå¹¶å°†è¯¥éšæœºæ•°çš„tagged pointer æ ‡è¯†ä½ï¼ˆé«˜1bitæˆ–è€…ä½1bitï¼‰ç½®ä¸º0ã€‚å³ï¼š</span><br><span class="line">//objc_debug_taggedpointer_obfuscator = objc_debug_taggedpointer_obfuscator &amp; (0x7FFFFFFFFFFFFFFFæˆ–è€…0xFFFFFFFFFFFFFFFE)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>objc_debug_taggedpointer_obfuscator </code>ä¹Ÿç®—æ˜¯å›«å›µåæ£æŒæ¡äº†ï¼Œå›åˆ°åˆšåˆšé‚£ä¸ª<code>classSlotForBasicTagIndex </code>å‡½æ•°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">static Class *</span><br><span class="line">classSlotForBasicTagIndex(objc_tag_index_t tag)</span><br><span class="line">&#123;</span><br><span class="line">    uintptr_t tagObfuscator = ((objc_debug_taggedpointer_obfuscator</span><br><span class="line">                                &gt;&gt; _OBJC_TAG_INDEX_SHIFT)</span><br><span class="line">                               &amp; _OBJC_TAG_INDEX_MASK);</span><br><span class="line">//è¿™é‡Œå°±å¾ˆå¥½ç†è§£äº†ï¼Œå°†éšæœºå¾—åˆ°çš„æ•°æ®ï¼ˆtaggedæ ‡è¯†ä½å·²ç½®0ï¼‰å³ç§»_OBJC_TAG_INDEX_SHIFTä½ã€‚</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">#if OBJC_MSB_TAGGED_POINTERS</span><br><span class="line">#   define _OBJC_TAG_INDEX_SHIFT 60</span><br><span class="line">#else</span><br><span class="line">#   define _OBJC_TAG_INDEX_SHIFT 1</span><br><span class="line">#endif</span><br><span class="line">æ€»æ˜¯æœ‰ä¸¤ç§æƒ…å†µï¼Œè¿™é‡Œå°±é€‰ä¸€ç§ç ”ç©¶ï¼ˆâ€œ_OBJC_TAG_INDEX_SHIFT 60â€ï¼‰</span><br><span class="line">å³ç§»60ä½ï¼Œç›¸å½“äºå–éšæœºæ•°objc_debug_taggedpointer_obfuscatorçš„é«˜å››ä½ã€‚</span><br><span class="line"></span><br><span class="line">#define _OBJC_TAG_INDEX_MASK 0x7</span><br><span class="line">ç„¶åå†å’Œ0x7è¿›è¡Œä½ä¸æ“ä½œã€‚</span><br><span class="line">å…¶å®è´¨å°±æ˜¯å–60bit~62bitã€‚ï¼ˆé«˜4bitä¸­çš„ä½3bitï¼‰</span><br><span class="line">*/</span><br><span class="line">    uintptr_t obfuscatedTag = tag ^ tagObfuscator;</span><br><span class="line">//tag å’Œ tagObfuscator è¿›è¡Œå¼‚æˆ–æ“ä½œã€‚</span><br><span class="line">    // Array index in objc_tag_classes includes the tagged bit itself</span><br><span class="line">#if SUPPORT_MSB_TAGGED_POINTERS</span><br><span class="line">    return &amp;objc_tag_classes[0x8 | obfuscatedTag];</span><br><span class="line">#else</span><br><span class="line">    return &amp;objc_tag_classes[(obfuscatedTag &lt;&lt; 1) | 1];</span><br><span class="line">#endif</span><br><span class="line">//å°†æ ‡å¿—ä½ç½®1ï¼Œç„¶ååœ¨objc_tag_classesæ•°ç»„ä¸­å–å‡ºï¼Œå†å–åœ°å€è¿”å›ã€‚</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å›åˆ°å¼€å§‹çš„<code>_objc_registerTaggedPointerClass</code>å‡½æ•°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">void</span><br><span class="line">_objc_registerTaggedPointerClass(objc_tag_index_t tag, Class cls)</span><br><span class="line">&#123;</span><br><span class="line">    if (objc_debug_taggedpointer_mask == 0) &#123;</span><br><span class="line">        _objc_fatal(&quot;tagged pointers are disabled&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Class *slot = classSlotForTagIndex(tag);</span><br><span class="line">/*</span><br><span class="line">è¿™é‡Œå·²ç»çŸ¥é“äº†ï¼Œslotæ˜¯é€šè¿‡tagå€¼ï¼Œåœ¨objc_tag_classesæ•°ç»„ä¸­å¯»æ‰¾å¯¹äºçš„Classï¼Œå¹¶è·å–å…¶åœ°å€ï¼Œèµ‹å€¼ç»™slotã€‚</span><br><span class="line">*/</span><br><span class="line">    if (!slot) &#123;</span><br><span class="line">        _objc_fatal(&quot;tag index %u is invalid&quot;, (unsigned int)tag);</span><br><span class="line">    &#125;</span><br><span class="line">//å¦‚æœæ²¡æœ‰è·å–åˆ°ï¼Œåˆ™abortå¹¶å‘ŠçŸ¥tag index is invalidã€‚</span><br><span class="line"></span><br><span class="line">    Class oldCls = *slot;</span><br><span class="line">    </span><br><span class="line">    if (cls  &amp;&amp;  oldCls  &amp;&amp;  cls != oldCls) &#123;</span><br><span class="line">        _objc_fatal(&quot;tag index %u used for two different classes &quot;</span><br><span class="line">                    &quot;(was %p %s, now %p %s)&quot;, tag, </span><br><span class="line">                    oldCls, oldCls-&gt;nameForLogging(), </span><br><span class="line">                    cls, cls-&gt;nameForLogging());</span><br><span class="line">    &#125;</span><br><span class="line">  //è¿™é‡Œæ˜¯åˆ¤æ–­è¯¥tag indexæ˜¯å¦è¢«å…¶ä»–classä½¿ç”¨ã€‚</span><br><span class="line"></span><br><span class="line">    *slot = cls;</span><br><span class="line"></span><br><span class="line">//ä¸‹é¢çš„è¿™æ®µï¼Œæœ‰å¾…æ¢ç©¶~~~</span><br><span class="line">    // Store a placeholder class in the basic tag slot that is </span><br><span class="line">    // reserved for the extended tag space, if it isn&#x27;t set already.</span><br><span class="line">    // Do this lazily when the first extended tag is registered so </span><br><span class="line">    // that old debuggers characterize bogus pointers correctly more often.</span><br><span class="line">    if (tag &lt; OBJC_TAG_First60BitPayload || tag &gt; OBJC_TAG_Last60BitPayload) &#123;</span><br><span class="line">        Class *extSlot = classSlotForBasicTagIndex(OBJC_TAG_RESERVED_7);</span><br><span class="line">        if (*extSlot == nil) &#123;</span><br><span class="line">            extern objc_class OBJC_CLASS_$___NSUnrecognizedTaggedPointer;</span><br><span class="line">            *extSlot = (Class)&amp;OBJC_CLASS_$___NSUnrecognizedTaggedPointer;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ°è¿™é‡Œï¼Œè¿™ä¸ªå‡½æ•°ç®—æ˜¯è§£æå®Œäº†ã€‚å…¶å®å®ƒåšçš„å°±æ˜¯ï¼š<br>1ã€åˆ¤æ–­tagged pointer disabledä¸å¦ã€‚<br>2ã€ç”¨tagå€¼åœ¨objc_tag_classesæ•°ç»„ä¸­æŸ¥æ‰¾ç›¸å¯¹åº”çš„Classï¼ˆæŸ¥æ‰¾è¿‡ç¨‹ä¸Šé¢å·²ç»åˆ†æè¿‡ï¼‰ã€‚<br>3ã€åˆ¤æ–­æ˜¯å¦æŸ¥æ‰¾åˆ°ã€‚å¦‚æœæŸ¥æ‰¾åˆ°ï¼Œåˆ¤æ–­æ˜¯å¦è¢«å ç”¨ã€‚</p>
<p>ä¸‹ä¸€ä¸ªå‡½æ•°<code>_objc_getClassForTag </code>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// Returns the registered class for the given tag.</span><br><span class="line">// Returns nil if the tag is valid but has no registered class.</span><br><span class="line">// Aborts if the tag is invalid.</span><br><span class="line">OBJC_EXPORT Class _Nullable</span><br><span class="line">_objc_getClassForTag(objc_tag_index_t tag)</span><br><span class="line">    OBJC_AVAILABLE(10.9, 7.0, 9.0, 1.0, 2.0);</span><br><span class="line"></span><br><span class="line">/***********************************************************************</span><br><span class="line">* _objc_getClassForTag</span><br><span class="line">* Returns the class that is using the given tagged pointer tag.</span><br><span class="line">* Returns nil if no class is using that tag or the tag is out of range.</span><br><span class="line">**********************************************************************/</span><br><span class="line">Class</span><br><span class="line">_objc_getClassForTag(objc_tag_index_t tag)</span><br><span class="line">&#123;</span><br><span class="line">    Class *slot = classSlotForTagIndex(tag);</span><br><span class="line">    if (slot) return *slot;</span><br><span class="line">    else return nil;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å˜¿ï¼Œå·§äº†ï¼Œ<code>classSlotForTagIndex</code>å‡½æ•°ï¼Œåœ¨åˆ†æä¸Šä¸ªå‡½æ•°çš„æ—¶å€™ï¼Œåˆ†æè¿‡äº†ã€‚è¯¦ç»†è¿‡ç¨‹è§<code>classSlotForBasicTagIndex </code>å‡½æ•°çš„åˆ†æè¿‡ç¨‹ã€‚</p>
<p>ä¸‹ä¸€ä¸ªå‡½æ•°<code>_objc_makeTaggedPointer</code>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">// Create a tagged pointer object with the given tag and payload.</span><br><span class="line">// Assumes the tag is valid.</span><br><span class="line">// Assumes tagged pointers are enabled.</span><br><span class="line">// The payload will be silently truncated to fit.</span><br><span class="line">static inline void * _Nonnull</span><br><span class="line">_objc_makeTaggedPointer(objc_tag_index_t tag, uintptr_t payload);</span><br><span class="line"></span><br><span class="line">static inline void * _Nonnull</span><br><span class="line">_objc_makeTaggedPointer(objc_tag_index_t tag, uintptr_t value)</span><br><span class="line">&#123;</span><br><span class="line">    // PAYLOAD_LSHIFT and PAYLOAD_RSHIFT are the payload extraction shifts.</span><br><span class="line">    // They are reversed here for payload insertion.</span><br><span class="line"></span><br><span class="line">    // assert(_objc_taggedPointersEnabled());</span><br><span class="line">    if (tag &lt;= OBJC_TAG_Last60BitPayload) &#123;</span><br><span class="line">//è¿™é‡Œåªåˆ†æè¿™ç§æƒ…å†µ</span><br><span class="line">        // assert(((value &lt;&lt; _OBJC_TAG_PAYLOAD_RSHIFT) &gt;&gt; _OBJC_TAG_PAYLOAD_LSHIFT) == value);</span><br><span class="line">        uintptr_t result =</span><br><span class="line">            (_OBJC_TAG_MASK | </span><br><span class="line">             ((uintptr_t)tag &lt;&lt; _OBJC_TAG_INDEX_SHIFT) | </span><br><span class="line">             ((value &lt;&lt; _OBJC_TAG_PAYLOAD_RSHIFT) &gt;&gt; _OBJC_TAG_PAYLOAD_LSHIFT));</span><br><span class="line">        return _objc_encodeTaggedPointer(result);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        // assert(tag &gt;= OBJC_TAG_First52BitPayload);</span><br><span class="line">        // assert(tag &lt;= OBJC_TAG_Last52BitPayload);</span><br><span class="line">        // assert(((value &lt;&lt; _OBJC_TAG_EXT_PAYLOAD_RSHIFT) &gt;&gt; _OBJC_TAG_EXT_PAYLOAD_LSHIFT) == value);</span><br><span class="line">        uintptr_t result =</span><br><span class="line">            (_OBJC_TAG_EXT_MASK |</span><br><span class="line">             ((uintptr_t)(tag - OBJC_TAG_First52BitPayload) &lt;&lt; _OBJC_TAG_EXT_INDEX_SHIFT) |</span><br><span class="line">             ((value &lt;&lt; _OBJC_TAG_EXT_PAYLOAD_RSHIFT) &gt;&gt; _OBJC_TAG_EXT_PAYLOAD_LSHIFT));</span><br><span class="line">        return _objc_encodeTaggedPointer(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…ˆåˆ†æ<code>result</code>çš„å€¼:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">uintptr_t result = (_OBJC_TAG_MASK |  ((uintptr_t)tag &lt;&lt; _OBJC_TAG_INDEX_SHIFT) | ((value &lt;&lt; _OBJC_TAG_PAYLOAD_RSHIFT) &gt;&gt; _OBJC_TAG_PAYLOAD_LSHIFT));</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">åŒæ ·çš„ï¼Œè¿™é‡Œåªåˆ†æ _OBJC_TAG_INDEX_SHIFT = 60 çš„æƒ…å†µ</span><br><span class="line">((uintptr_t)tag &lt;&lt; _OBJC_TAG_INDEX_SHIFT) ï¼šå°†tagçš„ä½4bitå˜ä¸ºé«˜4bit</span><br><span class="line">((value &lt;&lt; _OBJC_TAG_PAYLOAD_RSHIFT) &gt;&gt; _OBJC_TAG_PAYLOAD_LSHIFT)ï¼šå°†valueçš„é«˜4bitç½®0</span><br><span class="line">((uintptr_t)tag &lt;&lt; _OBJC_TAG_INDEX_SHIFT) | ((value &lt;&lt; _OBJC_TAG_PAYLOAD_RSHIFT) &gt;&gt; _OBJC_TAG_PAYLOAD_LSHIFT)ï¼šå°†tagçš„ä½å››ä½ç»™valueçš„é«˜å››ä½ã€‚</span><br><span class="line">ä¸Šé¢çš„æ“ä½œå°±ç›¸å½“äºï¼š</span><br><span class="line">tag:0x89abcdef</span><br><span class="line">value:0x76543210</span><br><span class="line">tagvalue:0xf6543210</span><br><span class="line"></span><br><span class="line">æ‰€ä»¥resultä¸ºä¸Šè¿°æ“ä½œä¹‹åçš„tagå’Œvalueå€¼çš„tagged pointeræ ‡è¯†ä½ï¼ˆ63bitï¼‰ç½®1ã€‚</span><br><span class="line">ä¸¾ä¸ªä¾‹å­ï¼š</span><br><span class="line">tag=0x76543210</span><br><span class="line">value=0xf9abcdef</span><br><span class="line">é‚£ä¹ˆresult=(1&lt;&lt;63) | ((tag&lt;&lt;60) | ((value&lt;&lt;4)&gt;&gt;4)) = 0x89abcdef</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>
<p>å†æ¥çœ‹çœ‹<code>_objc_encodeTaggedPointer </code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">static inline void * _Nonnull</span><br><span class="line">_objc_encodeTaggedPointer(uintptr_t ptr)</span><br><span class="line">&#123;</span><br><span class="line">    return (void *)(objc_debug_taggedpointer_obfuscator ^ ptr);</span><br><span class="line">/*</span><br><span class="line">objc_debug_taggedpointer_obfuscatoråœ¨ä¸Šé¢ä¹Ÿæ˜¯åˆ†æè¿‡çš„ï¼Œä»–æœ‰ä¸€ä¸ªåˆå§‹åŒ–å‡½æ•°initializeTaggedPointerObfuscatorã€‚</span><br><span class="line">å…¶å€¼ä¸ºä¸€ä¸ªç”±arc4random_bufç”Ÿæˆçš„64bitéšæœºæ•°ï¼Œç„¶åå†å°†_OBJC_TAG_MASKä½ï¼ˆæœ€é«˜ä½ï¼‰ç½®0ã€‚</span><br><span class="line">æ‰€ä»¥çš„å¾—åˆ°çš„ä¸ºï¼šresult^objc_debug_taggedpointer_obfuscator</span><br><span class="line">*/</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>çœ‹ä¸‹ä¸€ä¸ªå‡½æ•°<code>_objc_isTaggedPointer</code>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// Return true if ptr is a tagged pointer object.</span><br><span class="line">// Does not check the validity of ptr&#x27;s class.</span><br><span class="line">static inline bool </span><br><span class="line">_objc_isTaggedPointer(const void * _Nullable ptr);</span><br><span class="line"></span><br><span class="line">static inline bool </span><br><span class="line">_objc_isTaggedPointer(const void * _Nullable ptr)</span><br><span class="line">&#123;</span><br><span class="line">    return ((uintptr_t)ptr &amp; _OBJC_TAG_MASK) == _OBJC_TAG_MASK;</span><br><span class="line">/*</span><br><span class="line">è¿™ä¸ªå…¶å®å¾ˆç®€å•ï¼Œä¼ å…¥ä¸€ä¸ªæŒ‡é’ˆï¼Œåˆ¤æ–­æŒ‡é’ˆçš„_OBJC_TAG_MASKä½æ˜¯å¦ä¸º1ã€‚</span><br><span class="line">*/</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>_objc_getTaggedPointerTag</code>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">// Extract the tag value from the given tagged pointer object.</span><br><span class="line">// Assumes ptr is a valid tagged pointer object.</span><br><span class="line">// Does not check the validity of ptr&#x27;s tag.</span><br><span class="line">static inline objc_tag_index_t </span><br><span class="line">_objc_getTaggedPointerTag(const void * _Nullable ptr);</span><br><span class="line"></span><br><span class="line">static inline objc_tag_index_t </span><br><span class="line">_objc_getTaggedPointerTag(const void * _Nullable ptr) </span><br><span class="line">&#123;</span><br><span class="line">    // assert(_objc_isTaggedPointer(ptr));</span><br><span class="line">    uintptr_t value = _objc_decodeTaggedPointer(ptr);</span><br><span class="line">/*</span><br><span class="line">ç”¨éšæœºæ•°objc_debug_taggedpointer_obfuscatorå¯¹æŒ‡é’ˆè¿›è¡Œdecodeã€‚</span><br><span class="line">*/</span><br><span class="line">    uintptr_t basicTag = (value &gt;&gt; _OBJC_TAG_INDEX_SHIFT) &amp; _OBJC_TAG_INDEX_MASK;</span><br><span class="line">//    uintptr_t basicTag = (value &gt;&gt; 60) &amp; 0x7;//å°†decodeä¹‹åçš„valueçš„é«˜å››ä½å˜ä¸ºä½å››ä½ï¼Œå¹¶å°†å…¶3bitç½®ä¸º0ã€‚</span><br><span class="line"></span><br><span class="line">//ä»…æ˜¯ç ”ç©¶NSNumberç­‰ç±»çš„è¯ï¼Œä¸‹é¢çš„å°±ä¸ç”¨å»æ·±ç©¶ã€‚</span><br><span class="line">    uintptr_t extTag =   (value &gt;&gt; _OBJC_TAG_EXT_INDEX_SHIFT) &amp; _OBJC_TAG_EXT_INDEX_MASK;</span><br><span class="line"></span><br><span class="line">    if (basicTag == _OBJC_TAG_INDEX_MASK) &#123;</span><br><span class="line">        return (objc_tag_index_t)(extTag + OBJC_TAG_First52BitPayload);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return (objc_tag_index_t)basicTag;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>_objc_getTaggedPointerValue</code>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// Extract the payload from the given tagged pointer object.</span><br><span class="line">// Assumes ptr is a valid tagged pointer object.</span><br><span class="line">// The payload value is zero-extended.</span><br><span class="line">static inline uintptr_t</span><br><span class="line">_objc_getTaggedPointerValue(const void * _Nullable ptr);</span><br><span class="line"></span><br><span class="line">static inline uintptr_t</span><br><span class="line">_objc_getTaggedPointerValue(const void * _Nullable ptr) </span><br><span class="line">&#123;</span><br><span class="line">    // assert(_objc_isTaggedPointer(ptr));</span><br><span class="line">    uintptr_t value = _objc_decodeTaggedPointer(ptr);</span><br><span class="line">    uintptr_t basicTag = (value &gt;&gt; _OBJC_TAG_INDEX_SHIFT) &amp; _OBJC_TAG_INDEX_MASK;</span><br><span class="line">    if (basicTag == _OBJC_TAG_INDEX_MASK) &#123;</span><br><span class="line">        return (value &lt;&lt; _OBJC_TAG_EXT_PAYLOAD_LSHIFT) &gt;&gt; _OBJC_TAG_EXT_PAYLOAD_RSHIFT;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return (value &lt;&lt; _OBJC_TAG_PAYLOAD_LSHIFT) &gt;&gt; _OBJC_TAG_PAYLOAD_RSHIFT;</span><br><span class="line">//ä¸»è¦çœ‹è¿™é‡Œï¼Œvalueçš„å€¼æ˜¯_objc_decodeTaggedPointerçš„è¿”å›å€¼ï¼Œç„¶åå†å°†è¿™ä¸ªè¿”å›å€¼é«˜å››ä½ç½®0ï¼Œå³å¾—ã€‚</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>_objc_getTaggedPointerSignedValue</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">// Extract the payload from the given tagged pointer object.</span><br><span class="line">// Assumes ptr is a valid tagged pointer object.</span><br><span class="line">// The payload value is sign-extended.</span><br><span class="line">static inline intptr_t</span><br><span class="line">_objc_getTaggedPointerSignedValue(const void * _Nullable ptr);</span><br><span class="line"></span><br><span class="line">static inline intptr_t</span><br><span class="line">_objc_getTaggedPointerSignedValue(const void * _Nullable ptr) </span><br><span class="line">&#123;</span><br><span class="line">    // assert(_objc_isTaggedPointer(ptr));</span><br><span class="line">    uintptr_t value = _objc_decodeTaggedPointer(ptr);</span><br><span class="line">    uintptr_t basicTag = (value &gt;&gt; _OBJC_TAG_INDEX_SHIFT) &amp; _OBJC_TAG_INDEX_MASK;</span><br><span class="line">    if (basicTag == _OBJC_TAG_INDEX_MASK) &#123;</span><br><span class="line">        return ((intptr_t)value &lt;&lt; _OBJC_TAG_EXT_PAYLOAD_LSHIFT) &gt;&gt; _OBJC_TAG_EXT_PAYLOAD_RSHIFT;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return ((intptr_t)value &lt;&lt; _OBJC_TAG_PAYLOAD_LSHIFT) &gt;&gt; _OBJC_TAG_PAYLOAD_RSHIFT;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">/*</span><br><span class="line">è¿™ä¸ªå‡½æ•°å’Œä¸Šé¢çš„_objc_getTaggedPointerValueæ˜¯ä¸€æ ·çš„ã€‚</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>
<p>ç†è®ºåˆ°è¿™ç®—æ˜¯èµ°å®Œäº†ã€‚<br>è¿™é‡Œï¼Œæ€»ç»“ä¸€ä¸‹ï¼š<br>tagged pointeræ˜¯Appleåœ¨64bitç³»ç»Ÿä¸Šå¯¹NSNumberç±»çš„ä¸€äº›ä¼˜åŒ–ï¼Œä¸»è¦ç›®çš„æ˜¯ä¸ºäº†èŠ‚çœå†…å­˜ã€‚å…¶å®ç°åŸç†ä¸ºï¼šå°†æŒ‡é’ˆçš„ä¸€éƒ¨åˆ†ï¼ˆ4bitï¼‰æ‹¿å‡ºæ¥å……å½“tagå€¼ï¼Œæ ‡è®°å¯¹è±¡æŒ‡é’ˆæ˜¯å¦ä¸ºtagged pointerã€‚å¹¶åœ¨è¿™4bitä¸­ï¼Œè¿˜å­˜å‚¨äº†è¯¥æŒ‡é’ˆçš„æ‰€å±ç±»åœ¨objc_tag_classesæ•°ç»„ä¸­çš„indexã€‚é€šè¿‡ä¸€ç³»åˆ—å‡½æ•°å¯ä»¥å¯¹å…¶è¿›è¡Œæ“ä½œï¼Œä¾‹å¦‚åˆ¤æ–­æŒ‡é’ˆæ˜¯å¦ä¸ºtagged pointerï¼ˆ_objc_isTaggedPointerï¼‰ã€è·å–tagged pointerçš„æ•°æ®ï¼ˆ_objc_getTaggedPointerValueï¼‰ã€è·å–tagged pointerçš„ç±»å‹ï¼ˆ_objc_getTaggedPointerTagï¼‰ç­‰ç­‰ã€‚</p>
<h3 id="å®è·µï¼ˆç¯å¢ƒï¼šMACï¼Œç‰ˆæœ¬ï¼š10-14-5ï¼‰"><a href="#å®è·µï¼ˆç¯å¢ƒï¼šMACï¼Œç‰ˆæœ¬ï¼š10-14-5ï¼‰" class="headerlink" title="å®è·µï¼ˆç¯å¢ƒï¼šMACï¼Œç‰ˆæœ¬ï¼š10.14.5ï¼‰"></a>å®è·µï¼ˆç¯å¢ƒï¼šMACï¼Œç‰ˆæœ¬ï¼š10.14.5ï¼‰</h3><p>ç†è®ºææ‡‚äº†ï¼Œé‚£å°±æ¥æŒ‡å¯¼ä¸€ä¸‹å®è·µå§ï¼š</p>
<ul>
<li>1 ç”±å·²çŸ¥tagged pointer è·å–å…¶ç›¸å…³ä¿¡æ¯ã€‚<br>ï¼ˆ1ï¼‰æŸ¥çœ‹tagged pointer enable or disableã€‚<br>æ ¹æ®ä¸Šè¿°åˆ†æï¼Œåˆ¤æ–­pagged pointeræ˜¯å¦å¯ç”¨ï¼Œåº”è¯¥æ˜¯è°ƒç”¨å‡½æ•°<code>_objc_taggedPointersEnabled</code>ã€‚<br>ä½†æ˜¯<code>_objc_taggedPointersEnabled</code>å‡½æ•°æ˜¯è¢«<code>static</code>ä¿®é¥°çš„ï¼Œæ‰€ä»¥ä¸èƒ½<code>extern</code>å¹¶ä½¿ç”¨ã€‚åªèƒ½ç›´æ¥é‡å†™å…¶å®ç°ã€‚<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#import &lt;Foundation/Foundation.h&gt;</span><br><span class="line"></span><br><span class="line">bool sl_objc_taggedPointersEnabled(void)</span><br><span class="line">&#123;</span><br><span class="line">    extern uintptr_t objc_debug_taggedpointer_mask;</span><br><span class="line">    return (objc_debug_taggedpointer_mask != 0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main(int argc, const char * argv[]) &#123;</span><br><span class="line">    @autoreleasepool &#123;</span><br><span class="line">        </span><br><span class="line">        bool b = sl_objc_taggedPointersEnabled();</span><br><span class="line">        NSLog(@&quot;Enable:%d&quot;,b);</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
æŸ¥çœ‹æ‰“å°ï¼š<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2019-07-01 17:37:14.584230+0800 AAA[10865:711050] Enable:1</span><br></pre></td></tr></table></figure>
å¯çŸ¥ï¼Œåœ¨mac10.14.5ä¸Šï¼Œæ˜¯enabledçš„ã€‚<br>ï¼ˆ2ï¼‰åˆ¤æ–­ä¸€ä¸ªæŒ‡é’ˆæ˜¯ä¸æ˜¯Tagged Pointerã€‚<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#   define _OBJC_TAG_MASK 1UL//æœ¬æ¥éœ€è¦åˆ¤æ–­çš„ï¼Œè¿™é‡Œæµ‹è¯•çš„æ˜¯å·²çŸ¥çš„mac 10.14.5.æ‰€ä»¥ç›´æ¥å®šä¹‰</span><br><span class="line">bool sl_objc_isTaggedPointer(const void * _Nullable ptr)</span><br><span class="line">&#123;</span><br><span class="line">    return ((uintptr_t)ptr &amp; _OBJC_TAG_MASK) == _OBJC_TAG_MASK;</span><br><span class="line">&#125;</span><br><span class="line">int main(int argc, const char * argv[]) &#123;</span><br><span class="line">    @autoreleasepool &#123;</span><br><span class="line">        NSNumber *n = @123;</span><br><span class="line">        NSString *s = @&quot;123&quot;;</span><br><span class="line">        NSString *s_m_c = [[s mutableCopy] copy];</span><br><span class="line">        NSObject *o = [NSObject new];</span><br><span class="line">        bool nb = sl_objc_isTaggedPointer((__bridge void *)n);</span><br><span class="line">        bool sb = sl_objc_isTaggedPointer((__bridge void *)s);</span><br><span class="line">        bool smcb = sl_objc_isTaggedPointer((__bridge void *)s_m_c);</span><br><span class="line">        bool ob = sl_objc_isTaggedPointer((__bridge void *)o);</span><br><span class="line">        NSLog(@&quot;nb(0x%lx) is TaggedPointer %d&quot;,(uintptr_t)n,nb);</span><br><span class="line">        NSLog(@&quot;sb(0x%lx) is TaggedPointer %d&quot;,(uintptr_t)s,sb);</span><br><span class="line">        NSLog(@&quot;smcb(0x%lx) is TaggedPointer %d&quot;,(uintptr_t)s_m_c,smcb);</span><br><span class="line">        NSLog(@&quot;ob(0x%lx) is TaggedPointer %d&quot;,(uintptr_t)o,ob);</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
æ‰“å°ï¼š<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2019-07-01 17:58:36.116391+0800 AAA[10973:719191] nb(0x56b19f9c2784f641) is TaggedPointer 1</span><br><span class="line">2019-07-01 17:58:36.116530+0800 AAA[10973:719191] sb(0x100001058) is TaggedPointer 0</span><br><span class="line">2019-07-01 17:58:36.116538+0800 AAA[10973:719191] smcb(0x56b19f9c14b6bc53) is TaggedPointer 1</span><br><span class="line">2019-07-01 17:58:36.116544+0800 AAA[10973:719191] ob(0x10051e520) is TaggedPointer 0</span><br></pre></td></tr></table></figure>
ï¼ˆ3ï¼‰è·å–tagged pointerçš„ç±»å‹ï¼ˆtagæšä¸¾å€¼ï¼‰<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#   define _OBJC_TAG_INDEX_SHIFT 1</span><br><span class="line">#define _OBJC_TAG_INDEX_MASK 0x7</span><br><span class="line">extern uintptr_t objc_debug_taggedpointer_obfuscator;</span><br><span class="line">uintptr_t sl_objc_getTaggedPointerTag(const void * _Nullable ptr)</span><br><span class="line">&#123;</span><br><span class="line">    uintptr_t value = objc_debug_taggedpointer_obfuscator ^ (uintptr_t)ptr;</span><br><span class="line">    uintptr_t basicTag = (value &gt;&gt; _OBJC_TAG_INDEX_SHIFT) &amp; _OBJC_TAG_INDEX_MASK;</span><br><span class="line">    return basicTag;</span><br><span class="line">&#125;</span><br><span class="line">int main(int argc, const char * argv[]) &#123;</span><br><span class="line">    @autoreleasepool &#123;</span><br><span class="line">        NSNumber *n = @123;</span><br><span class="line">        NSString *s = @&quot;123&quot;;</span><br><span class="line">        NSString *s_m_c = [[s mutableCopy] copy];</span><br><span class="line">        uintptr_t n_t = sl_objc_getTaggedPointerTag((__bridge void *)n);</span><br><span class="line">        uintptr_t s_m_c_t = sl_objc_getTaggedPointerTag((__bridge void *)s_m_c);</span><br><span class="line">        NSLog(@&quot;n&#x27;s type is %ld&quot;,n_t);</span><br><span class="line">        NSLog(@&quot;s_m_c&#x27;s type is %ld&quot;,s_m_c_t);        </span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
logï¼š<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2019-07-04 09:41:34.017122+0800 AAA[11655:849484] n&#x27;s type is 3</span><br><span class="line">2019-07-04 09:41:34.017318+0800 AAA[11655:849484] s_m_c&#x27;s type is 2</span><br></pre></td></tr></table></figure>
å¯¹æ¯”logå’Œobjc_tag_index_tï¼š<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// 60-bit payloads</span><br><span class="line">    OBJC_TAG_NSAtom            = 0, </span><br><span class="line">    OBJC_TAG_1                 = 1, </span><br><span class="line">    OBJC_TAG_NSString          = 2, </span><br><span class="line">    OBJC_TAG_NSNumber          = 3, </span><br><span class="line">    OBJC_TAG_NSIndexPath       = 4, </span><br><span class="line">    OBJC_TAG_NSManagedObjectID = 5, </span><br><span class="line">    OBJC_TAG_NSDate            = 6,</span><br></pre></td></tr></table></figure>
ï¼ˆ4ï¼‰è·å–taggedpointerçš„æ‰€å±ç±»ï¼š<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">#   define _OBJC_TAG_INDEX_SHIFT 1</span><br><span class="line">#define _OBJC_TAG_INDEX_MASK 0x7</span><br><span class="line">extern uintptr_t objc_debug_taggedpointer_obfuscator;</span><br><span class="line">uintptr_t sl_objc_getTaggedPointerTag(const void * _Nullable ptr)</span><br><span class="line">&#123;</span><br><span class="line">    uintptr_t value = objc_debug_taggedpointer_obfuscator ^ (uintptr_t)ptr;</span><br><span class="line">    uintptr_t basicTag = (value &gt;&gt; _OBJC_TAG_INDEX_SHIFT) &amp; _OBJC_TAG_INDEX_MASK;</span><br><span class="line">    return basicTag;</span><br><span class="line">&#125;</span><br><span class="line">extern Class objc_debug_taggedpointer_classes[];</span><br><span class="line">Class *sl_classSlotForBasicTagIndex(uintptr_t tag)</span><br><span class="line">&#123;</span><br><span class="line">    uintptr_t tagObfuscator = ((objc_debug_taggedpointer_obfuscator</span><br><span class="line">                                &gt;&gt; _OBJC_TAG_INDEX_SHIFT)</span><br><span class="line">                               &amp; _OBJC_TAG_INDEX_MASK);</span><br><span class="line">    uintptr_t obfuscatedTag = tag ^ tagObfuscator;</span><br><span class="line">    // Array index in objc_tag_classes includes the tagged bit itself</span><br><span class="line">    return &amp;objc_debug_taggedpointer_classes[(obfuscatedTag &lt;&lt; 1) | 1];</span><br><span class="line">&#125;</span><br><span class="line">int main(int argc, const char * argv[]) &#123;</span><br><span class="line">    @autoreleasepool &#123;</span><br><span class="line">        NSNumber *n = @123;</span><br><span class="line">        NSString *s = @&quot;123&quot;;</span><br><span class="line">        NSString *s_m_c = [[s mutableCopy] copy];</span><br><span class="line">        uintptr_t n_t = sl_objc_getTaggedPointerTag((__bridge void *)n);</span><br><span class="line">        uintptr_t s_m_c_t = sl_objc_getTaggedPointerTag((__bridge void *)s_m_c);</span><br><span class="line">        Class *n_t_c = sl_classSlotForBasicTagIndex(n_t);</span><br><span class="line">        Class *s_m_c_t_c = sl_classSlotForBasicTagIndex(s_m_c_t);</span><br><span class="line">        NSLog(@&quot;n&#x27;s Class is %@&quot;,*n_t_c);</span><br><span class="line">        NSLog(@&quot;s_m_c&#x27;s Clss is %@&quot;,*s_m_c_t_c);</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
logï¼š<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2019-07-04 10:58:05.075581+0800 AAA[11913:876264] n&#x27;s Class is __NSCFNumber</span><br><span class="line">2019-07-04 10:58:05.075754+0800 AAA[11913:876264] s_m_c&#x27;s Clss is NSTaggedPointerString</span><br></pre></td></tr></table></figure>
çœ‹åˆ°ä¸Šé¢çš„ä¾‹å­ï¼Œæˆ–è®¸æˆ‘è¯¥éœ²å‡ºå¼ ç‹‚ä½†åˆä¸å¤±è°¦è™šçš„ç¬‘å®¹ï¼Œå› ä¸ºä¸€åˆ‡éƒ½é‚£ä¹ˆé¡ºåˆ©ï¼Œç†è®ºå¾—åˆ°äº†å°è¯ã€‚ç„¶è€Œï¼ŒçœŸçš„æ˜¯è¿™ä¹ˆä¸€å›äº‹å—ï¼Ÿä¸‹é¢çœ‹ä¸€ä¸ªä¸å°½äººæ„çš„ä¾‹å­ã€‚<br>ï¼ˆ5ï¼‰é€šè¿‡taggedpointerè·å–valueï¼š</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#   define _OBJC_TAG_PAYLOAD_LSHIFT 0</span><br><span class="line">#   define _OBJC_TAG_PAYLOAD_RSHIFT 4</span><br><span class="line">uintptr_t sl_objc_getTaggedPointerValue(const void * _Nullable ptr)</span><br><span class="line">&#123;</span><br><span class="line">    // assert(_objc_isTaggedPointer(ptr));</span><br><span class="line">    uintptr_t value = objc_debug_taggedpointer_obfuscator ^ (uintptr_t)ptr;</span><br><span class="line">//    uintptr_t basicTag = (value &gt;&gt; _OBJC_TAG_INDEX_SHIFT) &amp; _OBJC_TAG_INDEX_MASK;</span><br><span class="line">    return (value &lt;&lt; _OBJC_TAG_PAYLOAD_LSHIFT) &gt;&gt; _OBJC_TAG_PAYLOAD_RSHIFT;</span><br><span class="line">&#125;</span><br><span class="line">int main(int argc, const char * argv[]) &#123;</span><br><span class="line">    @autoreleasepool &#123;</span><br><span class="line">        NSNumber *n = @123;</span><br><span class="line">        uintptr_t n_v = sl_objc_getTaggedPointerValue((__bridge void *)n);</span><br><span class="line">        NSLog(@&quot;hex(123) = 0x%x&quot;,123);</span><br><span class="line">        NSLog(@&quot;n&#x27;s value is 0x%lx&quot;,n_v);</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>log:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2019-07-04 11:14:59.639165+0800 AAA[11959:881845] hex(123) = 0x7b</span><br><span class="line">2019-07-04 11:14:59.639316+0800 AAA[11959:881845] n&#x27;s value is 0x7b2</span><br></pre></td></tr></table></figure>
<p>æ˜¯ä¸æ˜¯æ„Ÿè§‰æœ‰ç‚¹ä¸å¯¹åŠ²ï¼Ÿ<br>æ¢ä¸€ä¸ªæ•°æ®ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NSNumber *n = [NSNumber numberWithLongLong:121111];</span><br><span class="line">        uintptr_t n_v = sl_objc_getTaggedPointerValue((__bridge void *)n);</span><br><span class="line">        NSLog(@&quot;hex(121111) = 0x%x&quot;,121111);</span><br><span class="line">        NSLog(@&quot;n&#x27;s value is 0x%lx&quot;,n_v);</span><br></pre></td></tr></table></figure>
<p>logï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2019-07-04 11:18:03.279558+0800 AAA[11967:882991] hex(121111) = 0x1d917</span><br><span class="line">2019-07-04 11:18:03.279719+0800 AAA[11967:882991] n&#x27;s value is 0x1d9173</span><br></pre></td></tr></table></figure>
<p>æ¯æ¬¡éƒ½å‘ç°ç®—å‡ºæ¥çš„valueåé¢æ€»æ˜¯å¤šä¸€ä½ã€‚ã€‚ã€‚ã€‚<br>æŸ¥äº†è›®å¤šèµ„æ–™ï¼ŒåªçŸ¥é“ï¼š<br><code>valueçš„ç¬¬1-4ä½æ˜¯NSNumberçš„ç±»å‹ï¼šæ¯”å¦‚ï¼Œcharæ˜¯0ã€shortæ˜¯1ã€intæ˜¯2ã€floatæ˜¯4ã€‚</code></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/iOS%E5%BC%80%E5%8F%91/" rel="tag"><i class="fa fa-tag"></i> iOSå¼€å‘</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/11/28/block/" rel="next" title="block">
                <i class="fa fa-chevron-left"></i> block
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/11/28/xcode-select-command/" rel="prev" title="xcode-select å‘½ä»¤">
                xcode-select å‘½ä»¤ <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.gif"
                alt="" />
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/">
              
                  <span class="site-state-item-count">44</span>
                  <span class="site-state-item-name">æ—¥å¿—</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">åˆ†ç±»</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">æ ‡ç­¾</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/sweetloser" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E6%9D%A5%E6%BA%90"><span class="nav-number">1.</span> <span class="nav-text">é—®é¢˜æ¥æº</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%8E%A2%E7%B4%A2%E5%8E%86%E7%A8%8B"><span class="nav-number">2.</span> <span class="nav-text">æ¢ç´¢å†ç¨‹</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81%E7%99%BE%E5%BA%A6"><span class="nav-number">2.1.</span> <span class="nav-text">1ã€ç™¾åº¦</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81Developer-Documention"><span class="nav-number">2.2.</span> <span class="nav-text">2ã€Developer Documention</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#runtime%E6%BA%90%E7%A0%81"><span class="nav-number">2.3.</span> <span class="nav-text">runtimeæºç </span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E8%B7%B5%EF%BC%88%E7%8E%AF%E5%A2%83%EF%BC%9AMAC%EF%BC%8C%E7%89%88%E6%9C%AC%EF%BC%9A10-14-5%EF%BC%89"><span class="nav-number">2.3.1.</span> <span class="nav-text">å®è·µï¼ˆç¯å¢ƒï¼šMACï¼Œç‰ˆæœ¬ï¼š10.14.5ï¼‰</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">SweetLoser</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">57.1k</span>
  
</div>


  <div class="powered-by">ç”± <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">ä¸»é¢˜ &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'nsqlnUwzwCfJ7zrGNM69C5L8-gzGzoHsz',
        appKey: 'zpCVIjqIeJa5OOs6Rgbl65eU',
        placeholder: 'Just go go',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  

  

  
  

  

  

  

</body>
</html>
